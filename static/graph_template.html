<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blamegraph</title>
    <style>
        /* replace with uplot css */

        body {
            display: flex;
        }

        .infos {
            display: flex;
            flex-direction: column;
        }
    </style>
    <script type="module">
        /* replace with uplot js */
        /* replace with uplot stack js */
        const data = $replace_with_data$;

        const plot = document.getElementById("plot");
        const info = document.getElementById("info");
        const info2 = document.getElementById("info2");

        function formatCommit(idx) {
            let c = data.commits[idx];
            return (
                `commit ${c.hash}`
                + `\nAuthor:         ${c.author} <${c.author_mail}>`
                + `\nAuthor Date:    ${new Date(c.author_time).toLocaleString()}`
                + `\nCommitter:      ${c.committer} <${c.committer_mail}>`
                + `\nCommitter Date: ${new Date(c.committer_time).toLocaleString()}`
                + `\n\n${c.subject}`
            );
        }

        // https://sashamaps.net/docs/resources/20-colors/
        // Related: https://en.wikipedia.org/wiki/Help:Distinguishable_colors
        const colors = [
            "#e6194B", // Red
            "#3cb44b", // Green
            "#ffe119", // Yellow
            "#4363d8", // Blue
            "#f58231", // Orange
            "#911eb4", // Purple
            "#42d4f4", // Cyan
            "#f032e6", // Magenta
            "#bfef45", // Lime
            "#fabed4", // Pink
            "#469990", // Teal
            "#dcbeff", // Lavender
            "#9A6324", // Brown
            "#fffac8", // Beige
            "#800000", // Maroon
            "#aaffc3", // Mint
            "#808000", // Olive
            "#ffd8b1", // Apricot
            "#000075", // Navy
            "#a9a9a9", // Grey
            // "#ffffff", // White
            // "#000000", // Black
        ];
        function stroke(i) { return colors[i % colors.length]; }
        function fill(i) { return `${stroke(i)}80`; }

        let series = data.series.map((s, i) => ({
            label: s.name,
            stroke: stroke(i),
            fill: fill(i),
            paths: uPlot.paths.stepped({ align: 1 }),
            value: (p, v, i, x) => data.series[i - 1].values[x],
        }));

        let stacked = getStackedOpts(
            data.title,
            [{}].concat(series),
            [data.time].concat(data.series.map(s => s.values)),
        );

        stacked.opts.title = data.title;
        stacked.opts.width = 800;
        stacked.opts.height = 600;
        stacked.opts.scales.x.time = true;
        stacked.opts.axes = [
            {},
            { values: (p, s, i, f) => s.map(v => `${Math.round(v / 1000)}k`) },
        ];

        // Update commit infos
        let lastX = null;
        let lastY = null;
        let lastIdx = null;
        stacked.opts.hooks.setCursor = [u => {
            let idx = u.cursor.idx;
            if (idx === null) {
                info.textContent = "none";
            } else {
                info.textContent = formatCommit(idx);
            }
            lastIdx = idx;
        }];

        let u = new uPlot(stacked.opts, stacked.data, plot);
        u.over.addEventListener("mousedown", e => {
            lastX = e.clientX;
            lastY = e.clientY;
        });
        u.over.addEventListener("mouseup", e => {
            if (lastIdx !== null && e.clientX === lastX && e.clientY === lastY) {
                info2.textContent = formatCommit(lastIdx);
            }
        });
    </script>
</head>

<body>
    <div id="plot"></div>
    <div class="infos">
        <h2>Hovered commit</h2>
        <pre id="info">none</pre>
        <h2>Clicked commit</h2>
        <pre id="info2">none</pre>
    </div>
</body>

</html>
